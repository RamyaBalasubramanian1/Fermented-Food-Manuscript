#install.packages("compositions")  
library(compositions)
library(stringr)
library(janitor)
library(ggplot2)
library(janitor)
library(dplyr)
library(compositions)
library(ghibli)
library(factoextra)
library(patchwork)
library(pheatmap)
library(ComplexHeatmap)

# Install the circlize package if not already installed
if (!requireNamespace("circlize", quietly = TRUE)) {
  install.packages("circlize")
}
library(reshape2)
library(rstatix)
library(ggpubr)
library(FSA)
library(circlize)
library(ggforce)
library(vegan)
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(factoextra)) install.packages("factoextra")
library(gridExtra)
library(ggplot2)
library(factoextra)
#install.packages("devtools")
#devtools::install_github("pmartinezarbizu/pairwiseAdonis", force = TRUE)
library(pairwiseAdonis)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
#install.packages("ggalluvial")
library(ggalluvial)
#install.packages("ggsankey")
library(ggsankey)
#install.packages("networkD3")
library(networkD3)
library(htmlwidgets)
library(purrr)
library(compositions)
library(Tjazi)
library(ComplexHeatmap)
library(circlize)
library(dplyr)
library(igraph)
library(ggraph)
library(ggplot2)
library(patchwork)
#################################################################################

mk_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/milk_kefir/gbm_strat/modules.tsv")
mk_remove <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/mk_to_Remove.csv")
removed_samples <- mk_remove %>%
  filter(is.na(Time) | (Time) == "" | tolower(Time) == "remove") %>%
  pull(Sample)
colnames(mk_strat) <- gsub("\\.", "-", colnames(mk_strat))

mk_strat <- row_to_names(mk_strat, 1)
mk_strat[, 3:ncol(mk_strat)] <- lapply(mk_strat[, 3:ncol(mk_strat)], as.numeric)
str(mk_strat)
library(tidyr)

mk_long <- pivot_longer(mk_strat, 
                        cols = -c(Taxon, Module), 
                        names_to = "Sample", 
                        values_to = "Contribution")
mk_long <- mk_long[mk_long$Contribution > 0, ]
mk_long$Sample <- sub("_interleaved.*", "", mk_long$Sample)

mk_long <- mk_long[!mk_long$Sample %in% removed_samples,]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

mk_long_annotated <- merge(mk_long, anno[, c("Module", "Annotation")], by = "Module", all.x = TRUE)
mk_long_annotated$Module <- NULL
names(mk_long_annotated)[names(mk_long_annotated) == "Annotation"] <- "Module"

#including molecule
# Load required package
# Merge annotation info into mk_long
mk_long_annotated <- merge(mk_long, anno[, c("Module", "Annotation", "Molecule")], 
                           by = "Module", all.x = TRUE)
mk_long_annotated <- mk_long_annotated %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 1: Filter data
filtered_data <- mk_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 3: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 4: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 5: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK.pdf", selector = "pdf")

###########################################
#applying prevalence cutoffs
# Step 1: Filter valid contributions and exclude unwanted annotations
filtered_data <- mk_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep taxa present in *all* samples (based on Contribution > 0)
total_samples <- filtered_data %>%
  distinct(Sample) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, Sample) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Step 5: Combine edges and create node list
all_edges <- bind_rows(edges1, edges2)

nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_MK_PREV.pdf", selector = "pdf")

####################################
wk_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/wk_final_run/waterkefir/strat/modules.tsv")
wk_strat <- row_to_names(wk_strat, 1)
wk_strat[, 3:ncol(wk_strat)] <- lapply(wk_strat[, 3:ncol(wk_strat)], as.numeric)
str(wk_strat)
library(tidyr)

wk_long <- pivot_longer(wk_strat, 
                        cols = -c(Taxon, Module), 
                        names_to = "Sample", 
                        values_to = "Contribution")
wk_long <- wk_long[wk_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]
wk_long_annotated <- merge(wk_long, anno[, c("Module", "Annotation")], by = "Module", all.x = TRUE)
wk_long_annotated$Module <- NULL
names(wk_long_annotated)[names(wk_long_annotated) == "Annotation"] <- "Module"

#including molecule
# Load required package
# Merge annotation info into mk_long
wk_long_annotated <- merge(wk_long, anno[, c("Module", "Annotation", "Molecule")], 
                           by = "Module", all.x = TRUE)
wk_long_annotated <- wk_long_annotated %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
###########
# Step 1: Filter data
filtered_data <- wk_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosyl methionine (SAM) synthesis", "Heatshock protein"))

# Step 2: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 3: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 4: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 5: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/section_3/GBM_PA_SANKEY_WK.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/section_3/GBM_PA_SANKEY_WK.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/section_3/GBM_PA_SANKEY_WK.pdf", selector = "pdf")
#######################################
#######apply a 30% prevalence threshold#
##########################################
library(dplyr)
library(networkD3)

# Step 1: Filter valid contributions and exclude unwanted annotations
filtered_data <- wk_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosyl methionine (SAM) synthesis", "Heatshock protein"))

# Step 2: Keep taxa present in *all* samples (based on Contribution > 0)
total_samples <- filtered_data %>%
  distinct(Sample) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, Sample) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Step 5: Combine edges and create node list
all_edges <- bind_rows(edges1, edges2)

nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_WK_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_WK_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_WK_PREV.pdf", selector = "pdf")
##########################################
kom_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/kombucha/gbm_strat/modules.tsv")
kom_strat <- row_to_names(kom_strat, 1)
kom_strat[, 3:ncol(kom_strat)] <- lapply(kom_strat[, 3:ncol(kom_strat)], as.numeric)
str(kom_strat)
library(tidyr)

kom_long <- pivot_longer(kom_strat, 
                         cols = -c(Taxon, Module), 
                         names_to = "Sample", 
                         values_to = "Contribution")
kom_long <- kom_long[kom_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

kom_long_annotated <- merge(kom_long, anno[, c("Module", "Annotation")], by = "Module", all.x = TRUE)
head(kom_long_annotated)
kom_long_annotated$Module <- NULL
names(kom_long_annotated)[names(kom_long_annotated) == "Annotation"] <- "Module"
##############################
kom_long_annotated <- merge(kom_long, anno[, c("Module", "Annotation", "Molecule")], 
                            by = "Module", all.x = TRUE)
kom_long_annotated <- kom_long_annotated %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
###########
# Step 1: Filter data
filtered_data <- kom_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heatshock protein"))

# Step 2: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 3: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 4: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 5: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
#########
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom.pdf", selector = "pdf")
####################################
#applying a prevalence threshold 50%
#############
library(dplyr)
library(networkD3)

# Step 1: Filter valid contributions and exclude unwanted annotations
filtered_data <- kom_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep taxa present in *all* samples (based on Contribution > 0)
total_samples <- filtered_data %>%
  distinct(Sample) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, Sample) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)
##########################

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 1) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Step 5: Combine edges and create node list
all_edges <- bind_rows(edges1, edges2)

nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom_prev.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom_prev.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_kom_prev.pdf", selector = "pdf")
############################################################
#################################################################
##paula mk#############################################################
###############################################
paula_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/paula/gbm_strat/modules.tsv")
paula_strat <- row_to_names(paula_strat, 1)
paula_strat[, 3:ncol(paula_strat)] <- lapply(paula_strat[, 3:ncol(paula_strat)], as.numeric)
str(paula_strat)
library(tidyr)

paula_long <- pivot_longer(paula_strat, 
                           cols = -c(Taxon, Module), 
                           names_to = "Sample", 
                           values_to = "Contribution")
paula_long <- paula_long[paula_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

paula_long_annotated <- merge(paula_long, anno[, c("Module", "Annotation")], by = "Module", all.x = TRUE)
head(paula_long_annotated)
paula_long_annotated$Sample <- sub("^(.*S[0-9]+).*", "\\1", paula_long_annotated$Sample)
paula_long_annotated$Module <- NULL
names(paula_long_annotated)[names(paula_long_annotated) == "Annotation"] <- "Module"
#######################
paula_long_annotated <- merge(paula_long, anno[, c("Module", "Annotation", "Molecule")], 
                              by = "Module", all.x = TRUE)
paula_long_annotated <- paula_long_annotated %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
###########
# Step 1: Filter data
filtered_data <- paula_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 1) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 3: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 4: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 5: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU.pdf", selector = "pdf")
####################################
#applying a prevalence threshold 50%
#############
library(dplyr)
library(networkD3)

# Step 1: Filter valid contributions and exclude unwanted annotations
filtered_data <- paula_long_annotated %>%
  filter(Contribution > 0) %>%
  filter(!Annotation %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep taxa present in *all* samples (based on Contribution > 0)
total_samples <- filtered_data %>%
  distinct(Sample) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, Sample) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)
##########################

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique annotations
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_annotations = n_distinct(Annotation), .groups = "drop") %>%
  filter(n_annotations > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Annotation
edges1 <- filtered_data %>%
  distinct(Taxon, Annotation) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Annotation)) %>%
  select(source, target, value)

# Annotation → Molecule
edges2 <- filtered_data %>%
  distinct(Annotation, Molecule) %>%
  mutate(value = 1,
         source = as.character(Annotation),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Step 5: Combine edges and create node list
all_edges <- bind_rows(edges1, edges2)

nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Final check for NA
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
##########
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PAU_PREV.pdf", selector = "pdf")
#####################################################
#####################################################
#doing the same for kimchi,sauerkruat and kvass(beet)

fs_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/FS/gbm_strat/modules.tsv", header = TRUE)
#fs_strat <- row_to_names(fs_strat, 1)
fs_strat[, 3:ncol(fs_strat)] <- lapply(fs_strat[, 3:ncol(fs_strat)], as.numeric)
str(fs_strat)
library(tidyr)

fs_long <- pivot_longer(fs_strat, 
                        cols = -c(Taxon, Module), 
                        names_to = "Sample", 
                        values_to = "Contribution")
fs_long <- fs_long[fs_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

fs_long_annotated <- merge(fs_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(fs_long_annotated)
fs_long_annotated$Sample <- sub("^(.*S[0-9]+).*", "\\1", fs_long_annotated$Sample)
fs_long_annotated$Module <- NULL
names(fs_long_annotated)[names(fs_long_annotated) == "Annotation"] <- "Module"
fs_long_annotated$Sample <- substr(fs_long_annotated$Sample, 1, 4)
colnames(fs_long_annotated)[colnames(fs_long_annotated) =="Sample"] = "ID"
fs_fermented <- fs_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
fs_fermented <- fs_fermented %>% filter(Substrate=="Brine")
fs_fermented <- fs_fermented %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- fs_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
#########################################################
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_BRINE_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_BRINE_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_BRINE_PREV.pdf", selector = "pdf")
##########################################################
fs_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/FS/gbm_strat/modules.tsv", header = TRUE)
#fs_strat <- row_to_names(fs_strat, 1)
fs_strat[, 3:ncol(fs_strat)] <- lapply(fs_strat[, 3:ncol(fs_strat)], as.numeric)
str(fs_strat)
library(tidyr)

fs_long <- pivot_longer(fs_strat, 
                        cols = -c(Taxon, Module), 
                        names_to = "Sample", 
                        values_to = "Contribution")
fs_long <- fs_long[fs_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

fs_long_annotated <- merge(fs_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(fs_long_annotated)
fs_long_annotated$Sample <- sub("^(.*S[0-9]+).*", "\\1", fs_long_annotated$Sample)
fs_long_annotated$Module <- NULL
names(fs_long_annotated)[names(fs_long_annotated) == "Annotation"] <- "Module"
fs_long_annotated$Sample <- substr(fs_long_annotated$Sample, 1, 4)
colnames(fs_long_annotated)[colnames(fs_long_annotated) =="Sample"] = "ID"
fs_fermented <- fs_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
fs_fermented <- fs_fermented %>% filter(Substrate=="Sugar")
fs_fermented <- fs_fermented %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- fs_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
################################################################################
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_SUGAR_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_SUGAR_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_SUGAR_PREV.pdf", selector = "pdf")


fs_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/FS/gbm_strat/modules.tsv", header = TRUE)
#fs_strat <- row_to_names(fs_strat, 1)
fs_strat[, 3:ncol(fs_strat)] <- lapply(fs_strat[, 3:ncol(fs_strat)], as.numeric)
str(fs_strat)
library(tidyr)

fs_long <- pivot_longer(fs_strat, 
                        cols = -c(Taxon, Module), 
                        names_to = "Sample", 
                        values_to = "Contribution")
fs_long <- fs_long[fs_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

fs_long_annotated <- merge(fs_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(fs_long_annotated)
fs_long_annotated$Sample <- sub("^(.*S[0-9]+).*", "\\1", fs_long_annotated$Sample)
fs_long_annotated$Module <- NULL
names(fs_long_annotated)[names(fs_long_annotated) == "Annotation"] <- "Module"
fs_long_annotated$Sample <- substr(fs_long_annotated$Sample, 1, 4)
colnames(fs_long_annotated)[colnames(fs_long_annotated) =="Sample"] = "ID"
fs_fermented <- fs_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
fs_fermented <- fs_fermented %>% filter(Substrate=="Dairy")
fs_fermented <- fs_fermented %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- fs_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heatshock protein"))

# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
P <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P
htmlwidgets::saveWidget(P, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_DAIRY_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_DAIRY_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_DAIRY_PREV.pdf", selector = "pdf")

#############################################
#aff food
aff_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/AFF/gbm_strat/modules.tsv", header = TRUE)
aff_strat[, 3:ncol(aff_strat)] <- lapply(aff_strat[, 3:ncol(aff_strat)], as.numeric)
str(aff_strat)
library(tidyr)

aff_long <- pivot_longer(aff_strat, 
                         cols = -c(Taxon, Module), 
                         names_to = "Sample", 
                         values_to = "Contribution")
aff_long <- aff_long[aff_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

aff_long_annotated <- merge(aff_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(aff_long_annotated)
aff_long_annotated$Sample <- substr(aff_long_annotated$Sample, 1, 4)
aff_long_annotated$Module <- NULL
names(aff_long_annotated)[names(aff_long_annotated) == "Annotation"] <- "Module"
colnames(aff_long_annotated)[colnames(aff_long_annotated) =="Sample"] = "ID"
##############################
aff_fermented <- aff_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
aff_fermented <- aff_fermented %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
##############################
aff_fermented <- aff_fermented %>% filter(Substrate=="Palm Tree")
#######
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- aff_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))
# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
P1 <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
P1
################################################################
#aff food
aff_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/AFF/gbm_strat/modules.tsv", header = TRUE)
aff_strat[, 3:ncol(aff_strat)] <- lapply(aff_strat[, 3:ncol(aff_strat)], as.numeric)
str(aff_strat)
library(tidyr)

aff_long <- pivot_longer(aff_strat, 
                         cols = -c(Taxon, Module), 
                         names_to = "Sample", 
                         values_to = "Contribution")
aff_long <- aff_long[aff_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

aff_long_annotated <- merge(aff_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(aff_long_annotated)
aff_long_annotated$Sample <- substr(aff_long_annotated$Sample, 1, 4)
aff_long_annotated$Module <- NULL
names(aff_long_annotated)[names(aff_long_annotated) == "Annotation"] <- "Module"
colnames(aff_long_annotated)[colnames(aff_long_annotated) =="Sample"] = "ID"
##############################
aff_fermented <- aff_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
##############################
aff_fermented <- aff_fermented %>% filter(Substrate=="Cereal")
aff_fermented <- aff_fermented %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
#######
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- aff_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))

# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.3) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
Q <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
Q
#####################################
#aff food
aff_strat <- read.table("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/AFF/gbm_strat/modules.tsv", header = TRUE)
aff_strat[, 3:ncol(aff_strat)] <- lapply(aff_strat[, 3:ncol(aff_strat)], as.numeric)
str(aff_strat)
library(tidyr)

aff_long <- pivot_longer(aff_strat, 
                         cols = -c(Taxon, Module), 
                         names_to = "Sample", 
                         values_to = "Contribution")
aff_long <- aff_long[aff_long$Contribution > 0, ]

anno <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/annotation_gbm.csv")
dim(anno)
#################
#################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

aff_long_annotated <- merge(aff_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(aff_long_annotated)
aff_long_annotated$Sample <- substr(aff_long_annotated$Sample, 1, 4)
aff_long_annotated$Module <- NULL
names(aff_long_annotated)[names(aff_long_annotated) == "Annotation"] <- "Module"
colnames(aff_long_annotated)[colnames(aff_long_annotated) =="Sample"] = "ID"
##############################
aff_fermented <- aff_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
##############################
aff_fermented <- aff_fermented %>% filter(Substrate=="Root and tuber")
#######
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- aff_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))
filtered_data <- filtered_data %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
R <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
R
#####################################################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

aff_long_annotated <- merge(aff_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(aff_long_annotated)
aff_long_annotated$Sample <- substr(aff_long_annotated$Sample, 1, 4)
aff_long_annotated$Module <- NULL
names(aff_long_annotated)[names(aff_long_annotated) == "Annotation"] <- "Module"
colnames(aff_long_annotated)[colnames(aff_long_annotated) =="Sample"] = "ID"
##############################
aff_fermented <- aff_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
##############################
aff_fermented <- aff_fermented %>% filter(Substrate=="Seed")
#######
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- aff_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))
filtered_data <- filtered_data %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
S <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
S
##########################
meta <- read.csv("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/meta_insilico.csv")
meta <- meta[,-c(7,8)]

aff_long_annotated <- merge(aff_long, anno[, c("Module", "Annotation", "Molecule")], by = "Module", all.x = TRUE)
head(aff_long_annotated)
aff_long_annotated$Sample <- substr(aff_long_annotated$Sample, 1, 4)
aff_long_annotated$Module <- NULL
names(aff_long_annotated)[names(aff_long_annotated) == "Annotation"] <- "Module"
colnames(aff_long_annotated)[colnames(aff_long_annotated) =="Sample"] = "ID"
##############################
aff_fermented <- aff_long_annotated %>%
  inner_join(meta, by = "ID") %>% 
  filter(!is.na(Fermented.food.category))
##############################
aff_fermented <- aff_fermented %>% filter(Substrate=="Dairy")
#######
# Step 1: Filter for presence and remove unwanted modules
filtered_data <- aff_fermented %>%
  filter(Contribution > 0) %>%
  filter(!Module %in% c("S-Adenosylmethionine (SAM) synthesis", "Heat shock protein"))
filtered_data <- filtered_data %>%
  filter(Taxon != "unclassified") %>%
  mutate(Taxon = sub(".*s__", "", Taxon))
# Step 2: Keep only taxa present in ≥ 60% of samples
total_samples <- filtered_data %>%
  distinct(ID) %>%
  nrow()

taxa_prevalent <- filtered_data %>%
  distinct(Taxon, ID) %>%
  group_by(Taxon) %>%
  summarise(n_samples = n(), .groups = "drop") %>%
  filter(n_samples / total_samples >= 0.5) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_prevalent)

# Step 3: Keep only taxa with >3 unique functional modules
taxa_to_keep <- filtered_data %>%
  group_by(Taxon) %>%
  summarise(n_modules = n_distinct(Module), .groups = "drop") %>%
  filter(n_modules > 2) %>%
  pull(Taxon)

filtered_data <- filtered_data %>%
  filter(Taxon %in% taxa_to_keep)

# Step 4: Create edges
# Taxon → Module
edges1 <- filtered_data %>%
  distinct(Taxon, Module) %>%
  mutate(value = 1,
         source = as.character(Taxon),
         target = as.character(Module)) %>%
  select(source, target, value)

# Module → Molecule
edges2 <- filtered_data %>%
  distinct(Module, Molecule) %>%
  mutate(value = 1,
         source = as.character(Module),
         target = as.character(Molecule)) %>%
  select(source, target, value)

# Combine edges
all_edges <- bind_rows(edges1, edges2)

# Step 5: Create node list and map to IDs
nodes <- data.frame(name = unique(c(all_edges$source, all_edges$target)), stringsAsFactors = FALSE)

all_edges <- all_edges %>%
  mutate(source_id = match(source, nodes$name) - 1,
         target_id = match(target, nodes$name) - 1)

# Safety check
stopifnot(!any(is.na(all_edges$source_id)), !any(is.na(all_edges$target_id)))

# Step 6: Plot the Sankey
T <- sankeyNetwork(Links = all_edges,
                   Nodes = nodes,
                   Source = "source_id",
                   Target = "target_id",
                   Value = "value",
                   NodeID = "name",
                   fontSize = 12,
                   nodeWidth = 30)

# View
T
##############################################################
htmlwidgets::saveWidget(P1, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PALM_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PALM_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_PALM_PREV.pdf", selector = "pdf")
htmlwidgets::saveWidget(Q, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_Cereal_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_Cereal_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_Cereal_PREV.pdf", selector = "pdf")
htmlwidgets::saveWidget(R, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_root_and_tuber_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_root_and_tuber_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_root_and_tuber_PREV.pdf", selector = "pdf")
htmlwidgets::saveWidget(R, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_seed_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_seed_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_seed_PREV.pdf", selector = "pdf")
htmlwidgets::saveWidget(T, "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_aff_dairy_PREV.html")
webshot2::webshot("C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_aff_dairy_PREV.html", file = "C:/Users/Ramya.Balasubramania/Desktop/paper_1/IN-SILICO/in-silico_master_file/final_figs/Supplementary/GBM_PA_SANKEY_aff_dairy_PREV.pdf", selector = "pdf")
